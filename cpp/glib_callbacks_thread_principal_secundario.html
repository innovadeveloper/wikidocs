<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLib: Callbacks en Threads Múltiples</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            line-height: 1.4;
            margin: 20px;
            background: white;
            color: black;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .section {
            margin-bottom: 30px;
            border: 1px solid #333;
            padding: 15px;
        }
        
        .section h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
            border-bottom: 2px solid #333;
            padding-bottom: 5px;
        }
        
        .code-block {
            background: #f8f8f8;
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            overflow-x: auto;
        }
        
        .main-thread-code {
            border-left: 3px solid #1f77b4;
        }
        
        .worker-thread-code {
            border-left: 3px solid #ff7f0e;
        }
        
        .thread-box {
            border: 2px solid #000;
            margin: 10px;
            padding: 15px;
            display: inline-block;
            vertical-align: top;
            width: 400px;
        }
        
        .thread-box h3 {
            margin: 0 0 10px 0;
            text-align: center;
            font-size: 16px;
            border-bottom: 1px solid #666;
            padding-bottom: 5px;
        }
        
        .main-thread {
            background: #f0f8ff;
        }
        
        .worker-thread {
            background: #fff8f0;
        }
        
        .component-box {
            border: 1px solid #666;
            margin: 5px 0;
            padding: 8px;
            font-size: 10px;
        }
        
        .component-context {
            background: #e6f2ff;
        }
        
        .component-loop {
            background: #ffe6f2;
        }
        
        .component-callback {
            background: #f0fff0;
        }
        
        .timeline {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            border: 1px solid #666;
            padding: 15px;
        }
        
        .timeline-column {
            width: 30%;
            text-align: center;
        }
        
        .timeline-column h4 {
            margin: 0 0 10px 0;
            font-size: 12px;
            background: #f0f0f0;
            padding: 5px;
        }
        
        .timeline-event {
            border: 1px solid #ccc;
            padding: 5px;
            margin: 3px 0;
            font-size: 9px;
            text-align: left;
        }
        
        .event-main {
            background: #e6f3ff;
        }
        
        .event-worker {
            background: #fff0e6;
        }
        
        .event-parallel {
            background: #f0f0f0;
            font-weight: bold;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #666;
            padding: 8px;
            text-align: left;
            font-size: 12px;
        }
        
        .comparison-table th {
            background: #f0f0f0;
            font-weight: bold;
        }
        
        .flow-diagram {
            border: 2px solid #000;
            margin: 15px 0;
            padding: 15px;
            text-align: center;
        }
        
        .flow-step {
            border: 1px solid #666;
            margin: 10px 0;
            padding: 10px;
            position: relative;
        }
        
        .flow-step h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            background: #f0f0f0;
            padding: 5px;
            text-align: center;
        }
        
        .arrow-down {
            font-size: 20px;
            text-align: center;
            margin: 5px 0;
        }
        
        .highlight {
            background: #ffffcc;
            font-weight: bold;
        }
        
        .warning-box {
            border: 2px solid #000;
            background: #fff;
            padding: 15px;
            margin: 15px 0;
            border-style: dashed;
        }
        
        .execution-flow {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin: 20px 0;
        }
        
        .execution-column {
            flex: 1;
            border: 1px solid #666;
            padding: 10px;
        }
        
        .execution-column h4 {
            margin: 0 0 10px 0;
            text-align: center;
            font-size: 12px;
            background: #f0f0f0;
            padding: 5px;
        }
        
        .callback-demo {
            border: 1px solid #666;
            margin: 10px 0;
            padding: 10px;
            background: #fafafa;
        }
    </style>
</head>
<body>
    <h1>GLib: Callbacks en Thread Principal vs Secundario</h1>
    
    <div class="section">
        <h2>1. Arquitectura: Dos Threads, Dos Context, Dos Loops</h2>
        
        <div style="text-align: center; margin: 20px 0;">
            <div class="thread-box main-thread">
                <h3>THREAD PRINCIPAL</h3>
                
                <div class="component-box component-context">
                    <strong>GMainContext *main_context</strong><br>
                    • Contexto independiente<br>
                    • Maneja eventos del thread principal
                </div>
                
                <div class="component-box component-loop">
                    <strong>GMainLoop *main_loop</strong><br>
                    • Loop asociado al main_context<br>
                    • g_main_loop_run() bloquea aquí
                </div>
                
                <div class="component-box component-callback">
                    <strong>on_main_timeout()</strong><br>
                    • Cada 2 segundos<br>
                    • printf("[Main] Tick...")
                </div>
                
                <div class="code-block main-thread-code" style="font-size: 9px; margin: 10px 0;">
// Thread principal
GMainContext *main_context = g_main_context_new();
GMainLoop *main_loop = g_main_loop_new(main_context, FALSE);

g_timeout_add_seconds_full(G_PRIORITY_DEFAULT, 2, 
                          on_main_timeout, NULL, NULL);

g_main_loop_run(main_loop); // Bloquea aquí
                </div>
            </div>
            
            <div class="thread-box worker-thread">
                <h3>THREAD SECUNDARIO (Worker)</h3>
                
                <div class="component-box component-context">
                    <strong>GMainContext *context</strong><br>
                    • Contexto INDEPENDIENTE<br>
                    • Aislado del thread principal
                </div>
                
                <div class="component-box component-loop">
                    <strong>GMainLoop *loop</strong><br>
                    • Loop asociado al context del worker<br>
                    • g_main_loop_run() bloquea aquí
                </div>
                
                <div class="component-box component-callback">
                    <strong>on_timeout()</strong><br>
                    • Cada 1 segundo<br>
                    • printf("[Worker] Tick...")
                </div>
                
                <div class="code-block worker-thread-code" style="font-size: 9px; margin: 10px 0;">
// Thread worker
GMainContext *context = g_main_context_new();
GMainLoop *loop = g_main_loop_new(context, FALSE);

g_timeout_add_seconds_full(G_PRIORITY_DEFAULT, 1, 
                          on_timeout, NULL, NULL);

g_main_context_push_thread_default(context);
g_main_loop_run(loop); // Bloquea aquí
                </div>
            </div>
        </div>
    </div>
    
    <div class="section">
        <h2>2. Flujo de Ejecución Completo</h2>
        
        <div class="execution-flow">
            <div class="execution-column">
                <h4>THREAD PRINCIPAL</h4>
                
                <div class="timeline-event event-main">
                    1. main() inicia
                </div>
                <div class="timeline-event event-main">
                    2. Crear main_context + main_loop
                </div>
                <div class="timeline-event event-main">
                    3. g_timeout_add_seconds(..., 2, ...)
                </div>
                <div class="timeline-event event-main">
                    4. pthread_create() → lanza worker
                </div>
                <div class="timeline-event event-main">
                    5. g_main_loop_run(main_loop)
                </div>
                <div class="timeline-event event-parallel">
                    ⏰ BUCLE: cada 2s → on_main_timeout()
                </div>
                <div class="timeline-event event-main">
                    6. "[Main] Tick desde thread principal"
                </div>
            </div>
            
            <div class="execution-column">
                <h4>THREAD WORKER</h4>
                
                <div class="timeline-event event-worker">
                    1. worker_thread() inicia
                </div>
                <div class="timeline-event event-worker">
                    2. Crear context + loop (independientes)
                </div>
                <div class="timeline-event event-worker">
                    3. g_timeout_add_seconds(..., 1, ...)
                </div>
                <div class="timeline-event event-worker highlight">
                    4. g_main_context_push_thread_default()
                </div>
                <div class="timeline-event event-worker">
                    5. g_main_loop_run(loop)
                </div>
                <div class="timeline-event event-parallel">
                    ⏰ BUCLE: cada 1s → on_timeout()
                </div>
                <div class="timeline-event event-worker">
                    6. "[Worker] Tick desde thread secundario"
                </div>
            </div>
            
            <div class="execution-column">
                <h4>SALIDA ENTRELAZADA</h4>
                
                <div class="callback-demo">
                    <div style="font-size: 10px; font-family: monospace;">
[Main] Iniciando loop principal<br>
[Worker] Iniciando loop<br>
[Worker] Tick desde thread secundario<br>
[Worker] Tick desde thread secundario<br>
[Main] Tick desde thread principal<br>
[Worker] Tick desde thread secundario<br>
[Worker] Tick desde thread secundario<br>
[Main] Tick desde thread principal<br>
[Worker] Tick desde thread secundario<br>
...
                    </div>
                </div>
                
                <div style="font-size: 11px; margin: 10px 0;">
                    <strong>Patrón temporal:</strong><br>
                    • Worker: 1s, 2s, 3s, 4s, 5s...<br>
                    • Main: 2s, 4s, 6s, 8s...<br>
                    • Completamente paralelos
                </div>
            </div>
        </div>
    </div>
    
    <div class="section">
        <h2>3. Conceptos Clave de GLib</h2>
        
        <div class="flow-step">
            <h4>GMainContext - El Despachador de Eventos</h4>
            <p style="font-size: 12px; margin: 5px 0;">
                • Es el "cerebro" que maneja todos los eventos (timeouts, I/O, signals)<br>
                • Cada thread puede tener su propio context independiente<br>
                • g_main_context_new() crea un context completamente aislado<br>
                • Los callbacks se registran y ejecutan en el context específico
            </p>
        </div>
        
        <div class="flow-step">
            <h4>GMainLoop - El Bucle Bloqueante</h4>
            <p style="font-size: 12px; margin: 5px 0;">
                • Es el bucle infinito que procesa eventos del context<br>
                • g_main_loop_run() bloquea el thread hasta que el loop termine<br>
                • Cada loop está asociado a UN context específico<br>
                • Dos loops pueden correr simultáneamente en threads diferentes
            </p>
        </div>
        
        <div class="flow-step">
            <h4>g_timeout_add_seconds_full() - Registro de Callbacks</h4>
            <p style="font-size: 12px; margin: 5px 0;">
                • Registra un callback periódico en el context DEFAULT del thread actual<br>
                • El callback se ejecutará en el mismo thread que tiene el loop corriendo<br>
                • Retorno TRUE = continúa, FALSE = se elimina automáticamente<br>
                • G_PRIORITY_DEFAULT determina el orden de ejecución de eventos
            </p>
        </div>
        
        <div class="flow-step highlight">
            <h4>g_main_context_push_thread_default() - ¡CRÍTICO!</h4>
            <p style="font-size: 12px; margin: 5px 0;">
                • Establece CUÁL context es el "default" para este thread<br>
                • Sin esto, g_timeout_add_seconds() usaría el context global<br>
                • Permite que cada thread tenga su propio "contexto por defecto"<br>
                • Debe emparejarse con g_main_context_pop_thread_default()
            </p>
        </div>
    </div>
    
    <div class="section">
        <h2>4. Comparación: Main Thread vs Worker Thread</h2>
        
        <table class="comparison-table">
            <tr>
                <th>Aspecto</th>
                <th>Thread Principal</th>
                <th>Thread Worker</th>
            </tr>
            <tr>
                <td>Creación del thread</td>
                <td>main() - automático</td>
                <td>pthread_create() - manual</td>
            </tr>
            <tr>
                <td>GMainContext</td>
                <td>main_context (nuevo)</td>
                <td>context (nuevo, independiente)</td>
            </tr>
            <tr>
                <td>GMainLoop</td>
                <td>main_loop</td>
                <td>loop (independiente)</td>
            </tr>
            <tr>
                <td>Default context</td>
                <td>No necesita push_thread_default</td>
                <td>g_main_context_push_thread_default()</td>
            </tr>
            <tr>
                <td>Frecuencia callback</td>
                <td>2 segundos</td>
                <td>1 segundo</td>
            </tr>
            <tr>
                <td>Función callback</td>
                <td>on_main_timeout()</td>
                <td>on_timeout()</td>
            </tr>
            <tr>
                <td>Limpieza</td>
                <td>unref context + loop</td>
                <td>pop_thread_default + unref</td>
            </tr>
            <tr>
                <td>Aislamiento</td>
                <td>Independiente del worker</td>
                <td>Independiente del main</td>
            </tr>
        </table>
    </div>
    
    <div class="section">
        <h2>5. Diagrama de Contextos y Eventos</h2>
        
        <div style="text-align: center; margin: 20px 0;">
            <div style="border: 2px solid #000; display: inline-block; padding: 15px; margin: 10px;">
                <h4>MAIN THREAD CONTEXT</h4>
                <div style="border: 1px solid #666; padding: 10px; margin: 5px; background: #e6f3ff;">
                    <strong>main_context</strong><br>
                    <small>Dirección: 0x7f8a1000</small>
                </div>
                <div style="font-size: 10px; margin: 5px;">↓ controla ↓</div>
                <div style="border: 1px solid #666; padding: 10px; margin: 5px; background: #ffe6f2;">
                    <strong>main_loop</strong><br>
                    <small>g_main_loop_run()</small>
                </div>
                <div style="font-size: 10px; margin: 5px;">↓ ejecuta ↓</div>
                <div style="border: 1px solid #666; padding: 5px; margin: 2px; background: #f0fff0; font-size: 10px;">
                    timeout_source (2s) → on_main_timeout()
                </div>
            </div>
            
            <div style="border: 2px solid #000; display: inline-block; padding: 15px; margin: 10px;">
                <h4>WORKER THREAD CONTEXT</h4>
                <div style="border: 1px solid #666; padding: 10px; margin: 5px; background: #e6f3ff;">
                    <strong>context</strong><br>
                    <small>Dirección: 0x7f8a2000</small>
                </div>
                <div style="font-size: 10px; margin: 5px;">↓ controla ↓</div>
                <div style="border: 1px solid #666; padding: 10px; margin: 5px; background: #ffe6f2;">
                    <strong>loop</strong><br>
                    <small>g_main_loop_run()</small>
                </div>
                <div style="font-size: 10px; margin: 5px;">↓ ejecuta ↓</div>
                <div style="border: 1px solid #666; padding: 5px; margin: 2px; background: #f0fff0; font-size: 10px;">
                    timeout_source (1s) → on_timeout()
                </div>
            </div>
        </div>
        
        <div style="text-align: center; font-size: 12px; margin: 20px 0;">
            <strong>Los contextos son COMPLETAMENTE INDEPENDIENTES</strong><br>
            No hay comunicación directa entre ellos - cada uno maneja sus propios eventos
        </div>
    </div>
    
    <div class="warning-box">
        <h4>⚠️ Punto Crítico: g_main_context_push_thread_default()</h4>
        <div class="code-block" style="font-size: 11px;">
// ❌ SIN push_thread_default
void* bad_worker(void* arg) {
    GMainContext *context = g_main_context_new();
    GMainLoop *loop = g_main_loop_new(context, FALSE);
    
    // ¡PROBLEMA! Este timeout irá al context GLOBAL, no al nuestro
    g_timeout_add_seconds(1, on_timeout, NULL);
    
    g_main_loop_run(loop); // Loop vacío - no recibe el timeout
    return NULL;
}

// ✅ CON push_thread_default
void* good_worker(void* arg) {
    GMainContext *context = g_main_context_new();
    GMainLoop *loop = g_main_loop_new(context, FALSE);
    
    // Establecer nuestro context como default para este thread
    g_main_context_push_thread_default(context);
    
    // Ahora el timeout irá a NUESTRO context
    g_timeout_add_seconds(1, on_timeout, NULL);
    
    g_main_loop_run(loop); // Loop recibe el timeout correctamente
    
    g_main_context_pop_thread_default(context);
    return NULL;
}
        </div>
    </div>
    
    <div class="section">
        <h2>6. Ciclo de Vida y Limpieza</h2>
        
        <div class="timeline">
            <div class="timeline-column">
                <h4>INICIALIZACIÓN</h4>
                <div class="timeline-event">1. g_main_context_new()</div>
                <div class="timeline-event">2. g_main_loop_new(context, FALSE)</div>
                <div class="timeline-event">3. g_timeout_add_seconds_full()</div>
                <div class="timeline-event highlight">4. g_main_context_push_thread_default()</div>
                <div class="timeline-event">5. g_main_loop_run()</div>
            </div>
            
            <div class="timeline-column">
                <h4>EJECUCIÓN</h4>
                <div class="timeline-event event-parallel">Loop infinito procesando eventos</div>
                <div class="timeline-event event-parallel">Callbacks ejecutándose periódicamente</div>
                <div class="timeline-event event-parallel">Cada thread en su propio bucle</div>
                <div class="timeline-event event-parallel">Salida entrelazada en consola</div>
                <div class="timeline-event event-parallel">Independencia total entre threads</div>
            </div>
            
            <div class="timeline-column">
                <h4>LIMPIEZA</h4>
                <div class="timeline-event">1. g_main_loop_quit() [si fuera necesario]</div>
                <div class="timeline-event">2. g_main_loop_unref()</div>
                <div class="timeline-event highlight">3. g_main_context_pop_thread_default()</div>
                <div class="timeline-event">4. g_main_context_unref()</div>
                <div class="timeline-event">5. return NULL (pthread termina)</div>
            </div>
        </div>
    </div>
    
    <div class="section">
        <h2>Resumen de Buenas Prácticas</h2>
        <div style="font-size: 14px; padding: 10px;">
            <p><strong>1. Un context por thread:</strong> Cada thread debe tener su propio GMainContext independiente.</p>
            
            <p><strong>2. Push thread default:</strong> Siempre usar g_main_context_push_thread_default() en threads secundarios.</p>
            
            <p><strong>3. Emparejamiento:</strong> Cada push_thread_default debe tener su pop_thread_default correspondiente.</p>
            
            <p><strong>4. Limpieza ordenada:</strong> unref en orden inverso al de creación (loop → context).</p>
            
            <p><strong>5. Callbacks seguros:</strong> Los callbacks se ejecutan en el mismo thread que tiene el loop corriendo.</p>
        </div>
    </div>
</body>
</html>